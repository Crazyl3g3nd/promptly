/*
 * File:        KeyTable.js
 * Version:     1.1.7
 * CVS:         $Idj$
 * Description: Keyboard navigation for HTML tables
 * Author:      Allan Jardine (www.sprymedia.co.uk)
 * Created:     Fri Mar 13 21:24:02 GMT 2009
 * Modified:    $Date$ by $Author$
 * Language:    Javascript
 * License:     GPL v2 or BSD 3 point style
 * Project:     Just a little bit of fun :-)
 * Contact:     www.sprymedia.co.uk/contact
 *
 * Copyright 2009-2011 Allan Jardine, all rights reserved.
 *
 * This source file is free software, under either the GPL v2 license or a
 * BSD style license, available at:
 *   http://datatables.net/license_gpl2
 *   http://datatables.net/license_bsd
 */
function KeyTable(a){function n(a){return function(b,c,d){if(b!==null&&typeof b!="number"||c!==null&&typeof c!="number"||typeof d!="function")if(typeof b=="object"&&typeof c=="function"){var e=B(b);q(a,e[0],e[1],c)}else alert("Unhandable event type was added: x"+b+"  y:"+c+"  z:"+d);else q(a,b,c,d)}}function o(a){return function(b,c,d){if(b!==null&&typeof arguments[0]!="number"||c!==null&&typeof arguments[1]!="number")if(typeof arguments[0]=="object"){var e=B(b);typeof arguments[1]=="function"?r(a,e[0],e[1],c):r(a,e[0],e[1])}else alert("Unhandable event type was removed: x"+b+"  y:"+c+"  z:"+d);else typeof arguments[2]=="function"?r(a,b,c,d):r(a,b,c)}}function q(a,b,c,d){i[a].push({x:b,y:c,fn:d})}function r(a,b,c,d){var e=0;for(var f=0,g=i[a].length;f<g-e;f++)if(typeof d!="undefined")i[a][f-e].x==b&&i[a][f-e].y==c&&i[a][f-e].fn==d&&(i[a].splice(f-e,1),e++);else if(i[a][f-e].x==b&&i[a][f-e].y==c)return i[a].splice(f,1),1;return e}function s(a,b,c){var d=0,e=i[a];for(var f=0;f<e.length;f++)if(e[f].x==b&&e[f].y==c||e[f].x===null&&e[f].y==c||e[f].x==b&&e[f].y===null||e[f].x===null&&e[f].y===null)e[f].fn(A(b,c),b,c),d++;return d}function t(a,b){if(c==a)return;typeof b=="undefined"&&(b=!0),c!==null&&v(c),jQuery(a).addClass(g),jQuery(a).parent().addClass(g);var f;if(j){f=j.fnSettings();var i=F(a)[1],k=h;while(i>=f.fnDisplayEnd())f._iDisplayLength>=0?f._iDisplayStart+f._iDisplayLength<f.fnRecordsDisplay()&&(f._iDisplayStart+=f._iDisplayLength):f._iDisplayStart=0,j.oApi._fnCalculateEnd(f);while(i<f._iDisplayStart)f._iDisplayStart=f._iDisplayLength>=0?f._iDisplayStart-f._iDisplayLength:0,f._iDisplayStart<0&&(f._iDisplayStart=0),j.oApi._fnCalculateEnd(f);j.oApi._fnDraw(f),h=k}var l=B(a);c=a,d=l[0],e=l[1];var m,n,o,p,q,r,t;b&&(m=document.documentElement.clientHeight,n=document.documentElement.clientWidth,o=document.body.scrollTop||document.documentElement.scrollTop,p=document.body.scrollLeft||document.documentElement.scrollLeft,q=a.offsetHeight,r=a.offsetWidth,t=E(a),j&&typeof f.oScroll!="undefined"&&(f.oScroll.sX!==""||f.oScroll.sY!=="")&&(t[1]-=$(f.nTable.parentNode).scrollTop(),t[0]-=$(f.nTable.parentNode).scrollLeft()),t[1]+q>o+m?C(t[1]+q-m):t[1]<o&&C(t[1]),t[0]+r>p+n?D(t[0]+r-n):t[0]<p&&D(t[0]));if(j&&typeof f.oScroll!="undefined"&&(f.oScroll.sX!==""||f.oScroll.sY!=="")){var u=f.nTable.parentNode;m=u.clientHeight,n=u.clientWidth,o=u.scrollTop,p=u.scrollLeft,q=a.offsetHeight,r=a.offsetWidth,a.offsetTop+q>m+o?u.scrollTop=a.offsetTop+q-m:a.offsetTop<o&&(u.scrollTop=a.offsetTop),a.offsetLeft+r>n+p?u.scrollLeft=a.offsetLeft+r-n:a.offsetLeft<p&&(u.scrollLeft=a.offsetLeft)}y(),s("focus",d,e)}function u(){v(c),d=null,e=null,c=null,z()}function v(a){jQuery(a).removeClass(g),jQuery(a).parent().removeClass(g),s("blur",d,e)}function w(a){var b=this;while(b.nodeName!="TD")b=b.parentNode;t(b),y()}function x(a){if(f.block||!h)return!0;if(a.metaKey||a.altKey||a.ctrlKey)return!0;var g,i,n=b.getElementsByTagName("tr")[0].getElementsByTagName("td").length,o;if(j){var p=j.fnSettings();o=p.aiDisplay.length;var q=F(c);if(q===null)return;d=q[0],e=q[1]}else o=b.getElementsByTagName("tr").length;var r=a.keyCode==9&&a.shiftKey?-1:a.keyCode;switch(r){case 13:return a.preventDefault(),a.stopPropagation(),s("action",d,e),!0;case 27:if(!s("esc",d,e)){u();return}g=d,i=e;break;case-1:case 37:if(d>0)g=d-1,i=e;else{if(!(e>0))return r==-1&&k?(m=!0,l.focus(),setTimeout(function(){m=!1},0),h=!1,u(),!0):!1;g=n-1,i=e-1}break;case 38:if(!(e>0))return!1;g=d,i=e-1;break;case 9:case 39:if(d<n-1)g=d+1,i=e;else{if(!(e<o-1))return r==9&&k?(m=!0,l.focus(),setTimeout(function(){m=!1},0),h=!1,u(),!0):!1;g=0,i=e+1}break;case 40:if(!(e<o-1))return!1;g=d,i=e+1;break;default:return!0}return t(A(g,i)),!1}function y(){h||(h=!0)}function z(){h=!1}function A(a,c){if(j){var d=j.fnSettings();return typeof d.aoData[d.aiDisplay[c]]!="undefined"?d.aoData[d.aiDisplay[c]].nTr.getElementsByTagName("td")[a]:null}return jQuery("tr:eq("+c+")>td:eq("+a+")",b)[0]}function B(a){if(j){var b=j.fnSettings();return[jQuery("td",a.parentNode).index(a),jQuery("tr",a.parentNode.parentNode).index(a.parentNode)+b._iDisplayStart]}return[jQuery("td",a.parentNode).index(a),jQuery("tr",a.parentNode.parentNode).index(a.parentNode)]}function C(a){document.documentElement.scrollTop=a,document.body.scrollTop=a}function D(a){document.documentElement.scrollLeft=a,document.body.scrollLeft=a}function E(a){var b=0,c=0;if(a.offsetParent){b=a.offsetLeft,c=a.offsetTop,a=a.offsetParent;while(a)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent}return[b,c]}function F(a){var b=j.fnSettings();for(var c=0,d=b.aiDisplay.length;c<d;c++){var e=b.aoData[b.aiDisplay[c]].nTr,f=e.getElementsByTagName("td");for(var g=0,h=f.length;g<h;g++)if(f[g]==a)return[g,c]}return null}function G(a,c){f=c,typeof a=="undefined"&&(a={}),typeof a.focus=="undefined"&&(a.focus=[0,0]),typeof a.table=="undefined"?a.table=jQuery("table.KeyTable")[0]:$(a.table).addClass("KeyTable"),typeof a.focusClass!="undefined"&&(g=a.focusClass),typeof a.datatable!="undefined"&&(j=a.datatable),typeof a.initScroll=="undefined"&&(a.initScroll=!0),typeof a.form=="undefined"&&(a.form=!1),k=a.form,b=a.table.getElementsByTagName("tbody")[0];if(k){var d=document.createElement("div");l=document.createElement("input"),d.style.height="1px",d.style.width="0px",d.style.overflow="hidden",typeof a.tabIndex!="undefined"&&(l.tabIndex=a.tabIndex),d.appendChild(l),a.table.parentNode.insertBefore(d,a.table.nextSibling),jQuery(l).focus(function(){m||(h=!0,m=!1,typeof a.focus.nodeName!="undefined"?t(a.focus,a.initScroll):t(A(a.focus[0],a.focus[1]),a.initScroll),setTimeout(function(){l.blur()},0))}),h=!1}else typeof a.focus.nodeName!="undefined"?t(a.focus,a.initScroll):t(A(a.focus[0],a.focus[1]),a.initScroll),y();jQuery.browser.mozilla||jQuery.browser.opera?jQuery(document).bind("keypress",x):jQuery(document).bind("keydown",x),j?jQuery("tbody td",j.fnSettings().nTable).live("click",w):jQuery("td",b).live("click",w),jQuery(document).click(function(b){var c=b.target,d=!1;while(c){if(c==a.table){d=!0;break}c=c.parentNode}d||u()})}this.block=!1,this.event={remove:{}},this.fnGetCurrentPosition=function(){return[d,e]},this.fnGetCurrentData=function(){return c.innerHTML},this.fnGetCurrentTD=function(){return c},this.fnSetPosition=function(a,b){typeof a=="object"&&a.nodeName?t(a):t(A(a,b))};var b=null,c=null,d=null,e=null,f=null,g="focus",h=!1,i={action:[],esc:[],focus:[],blur:[]},j=null,k,l,m=!1;for(var p in i)p&&(this.event[p]=n(p),this.event.remove[p]=o(p));G(a,this)};